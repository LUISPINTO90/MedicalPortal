import bcrypt from "bcryptjs";
import prisma from "./utils/prisma";

async function main() {
  console.log("üå± Iniciando seed de la base de datos...");

  // 1. Crear usuario administrador de prueba
  const hashedPassword = await bcrypt.hash("adminadmin", 10);

  const user = await prisma.user.upsert({
    where: { email: "admin@admin.com" },
    update: {},
    create: {
      email: "admin@admin.com",
      password: hashedPassword,
    },
  });

  console.log("‚úÖ Usuario administrador creado:", user.email);

  // 2. Crear pacientes de prueba (solo si no existen)
  const patientsData = [
    {
      nombre: "Mar√≠a Jos√©",
      apellidos: "Garc√≠a L√≥pez",
      edad: 28,
      curp: "GALM950815MDFRRR01",
      telefono: "5551234567",
      direccion: "Calle Reforma 123, Col. Centro, CDMX",
      email: "maria.garcia@email.com",
      tipoSangre: "O+",
      sexo: "F",
      observaciones:
        "Al√©rgica a la penicilina. Antecedentes de hipertensi√≥n familiar.",
      userId: user.id,
    },
    {
      nombre: "Carlos Eduardo",
      apellidos: "Mart√≠nez Silva",
      edad: 45,
      curp: "MASC780320HDFRRL08",
      telefono: "5559876543",
      direccion: "Av. Insurgentes Sur 456, Col. Roma Norte, CDMX",
      email: "carlos.martinez@email.com",
      tipoSangre: "A+",
      sexo: "M",
      observaciones:
        "Diab√©tico tipo 2. Toma metformina 850mg dos veces al d√≠a.",
      userId: user.id,
    },
    {
      nombre: "Ana Patricia",
      apellidos: "Rodr√≠guez Hern√°ndez",
      edad: 34,
      curp: "ROHA890512MDFRDN03",
      telefono: "5556789012",
      direccion: "Calle 5 de Mayo 789, Col. Doctores, CDMX",
      email: "ana.rodriguez@email.com",
      tipoSangre: "B-",
      sexo: "F",
      observaciones: "Embarazada (20 semanas). Control prenatal regular.",
      userId: user.id,
    },
    {
      nombre: "Roberto",
      apellidos: "Jim√©nez Morales",
      edad: 67,
      curp: "JIMR570218HDFRMT05",
      telefono: "5554567890",
      direccion: "Privada San Juan 321, Col. Coyoac√°n, CDMX",
      email: "roberto.jimenez@email.com",
      tipoSangre: "AB+",
      sexo: "M",
      observaciones:
        "Hipertensi√≥n arterial controlada. Marcapasos implantado en 2020.",
      userId: user.id,
    },
    {
      nombre: "Sof√≠a",
      apellidos: "Gonz√°lez V√°squez",
      edad: 22,
      curp: "GOVS010903MDFNZF07",
      telefono: "5552345678",
      direccion: "Calle Universidad 654, Col. Del Valle, CDMX",
      email: "sofia.gonzalez@email.com",
      tipoSangre: "O-",
      sexo: "F",
      observaciones:
        "Estudiante universitaria. Sin antecedentes m√©dicos relevantes.",
      userId: user.id,
    },
    {
      nombre: "Pedro Luis",
      apellidos: "S√°nchez Torres",
      edad: 52,
      curp: "SATP710825HDFRDR02",
      telefono: "5558901234",
      direccion: "Av. Revoluci√≥n 987, Col. San √Ångel, CDMX",
      tipoSangre: "A-",
      sexo: "M",
      observaciones:
        "Antecedentes de infarto hace 3 a√±os. Toma anticoagulantes.",
      userId: user.id,
    },
  ];

  const patients = [];
  for (const patientData of patientsData) {
    try {
      const existingPatient = await prisma.patient.findUnique({
        where: { curp: patientData.curp },
      });

      if (!existingPatient) {
        const patient = await prisma.patient.create({
          data: patientData,
        });
        patients.push(patient);
        console.log(
          `‚úÖ Paciente creado: ${patient.nombre} ${patient.apellidos}`
        );
      } else {
        patients.push(existingPatient);
        console.log(
          `‚ÑπÔ∏è Paciente ya existe: ${existingPatient.nombre} ${existingPatient.apellidos}`
        );
      }
    } catch (error) {
      console.log(`‚ö†Ô∏è Error creando paciente ${patientData.nombre}: ${error}`);
    }
  }

  // 3. Verificar si las tablas de citas y tratamientos existen
  try {
    const appointmentCount = await prisma.appointment.count();
    console.log(`‚ÑπÔ∏è Citas existentes en la base de datos: ${appointmentCount}`);
  } catch (error) {
    console.log(
      "‚ö†Ô∏è La tabla 'appointments' no existe a√∫n. Ejecuta 'npx prisma db push' primero."
    );
    return;
  }

  try {
    const treatmentCount = await prisma.treatment.count();
    console.log(
      `‚ÑπÔ∏è Tratamientos existentes en la base de datos: ${treatmentCount}`
    );
  } catch (error) {
    console.log(
      "‚ö†Ô∏è La tabla 'treatments' no existe a√∫n. Ejecuta 'npx prisma db push' primero."
    );
    return;
  }

  // 4. Crear citas de prueba
  const today = new Date();
  const tomorrow = new Date(today);
  tomorrow.setDate(tomorrow.getDate() + 1);
  const nextWeek = new Date(today);
  nextWeek.setDate(nextWeek.getDate() + 7);
  const lastWeek = new Date(today);
  lastWeek.setDate(lastWeek.getDate() - 7);

  const appointmentsData = [
    {
      fecha: today,
      hora: "09:30",
      motivo: "Consulta general",
      notas:
        "Paciente refiere dolor de cabeza recurrente desde hace una semana.",
      estatus: "PENDIENTE" as const,
      patientId: patients[0].id,
      userId: user.id,
    },
    {
      fecha: today,
      hora: "11:00",
      motivo: "Control de diabetes",
      notas: "Revisi√≥n de niveles de glucosa y ajuste de medicaci√≥n.",
      estatus: "PENDIENTE" as const,
      patientId: patients[1].id,
      userId: user.id,
    },
    {
      fecha: tomorrow,
      hora: "10:15",
      motivo: "Control prenatal",
      notas: "Ultrasonido de rutina semana 20.",
      estatus: "PENDIENTE" as const,
      patientId: patients[2].id,
      userId: user.id,
    },
    {
      fecha: nextWeek,
      hora: "14:30",
      motivo: "Seguimiento cardiol√≥gico",
      notas: "Revisi√≥n de marcapasos y electrocardiograma.",
      estatus: "PENDIENTE" as const,
      patientId: patients[3].id,
      userId: user.id,
    },
    {
      fecha: lastWeek,
      hora: "16:00",
      motivo: "Consulta por lesi√≥n deportiva",
      notas: "Esguince de tobillo derecho durante pr√°ctica de f√∫tbol.",
      estatus: "REALIZADA" as const,
      patientId: patients[4].id,
      userId: user.id,
    },
    {
      fecha: lastWeek,
      hora: "13:45",
      motivo: "Consulta cardiol√≥gica urgente",
      notas: "Paciente cancel√≥ por mejora en s√≠ntomas.",
      estatus: "CANCELADA" as const,
      patientId: patients[5].id,
      userId: user.id,
    },
  ];

  for (const appointmentData of appointmentsData) {
    try {
      const appointment = await prisma.appointment.create({
        data: appointmentData,
      });
      console.log(
        `‚úÖ Cita creada: ${appointment.motivo} - ${appointment.estatus}`
      );
    } catch (error) {
      console.log(`‚ö†Ô∏è Error creando cita: ${error}`);
    }
  }

  // 5. Crear tratamientos de prueba
  const treatmentsData = [
    {
      nombre: "Fisioterapia para esguince",
      descripcion:
        "Sesiones de fisioterapia para rehabilitaci√≥n de esguince de tobillo derecho. Incluye ejercicios de fortalecimiento y movilidad.",
      fechaInicio: new Date(lastWeek.getTime() + 24 * 60 * 60 * 1000), // Un d√≠a despu√©s de la cita
      duracion: "4 semanas",
      observaciones:
        "3 sesiones por semana. Aplicar hielo despu√©s de cada sesi√≥n.",
      activo: true,
      patientId: patients[4].id,
      userId: user.id,
    },
    {
      nombre: "Control gluc√©mico intensivo",
      descripcion:
        "Programa de control estricto de diabetes tipo 2 con monitoreo diario de glucosa y ajuste de medicaci√≥n.",
      fechaInicio: new Date(today.getTime() - 30 * 24 * 60 * 60 * 1000), // Hace 30 d√≠as
      duracion: "3 meses",
      observaciones:
        "Medici√≥n de glucosa 4 veces al d√≠a. Dieta estricta baja en carbohidratos.",
      activo: true,
      patientId: patients[1].id,
      userId: user.id,
    },
    {
      nombre: "Seguimiento prenatal",
      descripcion:
        "Control m√©dico especializado durante el embarazo con monitoreo fetal y materno regular.",
      fechaInicio: new Date(today.getTime() - 60 * 24 * 60 * 60 * 1000), // Hace 60 d√≠as
      duracion: "20 semanas restantes",
      observaciones:
        "Ultrasonidos mensuales. Suplementos de √°cido f√≥lico y hierro.",
      activo: true,
      patientId: patients[2].id,
      userId: user.id,
    },
    {
      nombre: "Terapia antihipertensiva",
      descripcion:
        "Tratamiento farmacol√≥gico para control de hipertensi√≥n arterial con IECA y diur√©ticos.",
      fechaInicio: new Date(today.getTime() - 90 * 24 * 60 * 60 * 1000), // Hace 90 d√≠as
      duracion: "6 meses",
      observaciones:
        "Monitoreo semanal de presi√≥n arterial. Dieta baja en sodio.",
      activo: true,
      patientId: patients[3].id,
      userId: user.id,
    },
    {
      nombre: "Profilaxis antibi√≥tica",
      descripcion:
        "Tratamiento preventivo con antibi√≥ticos por procedimiento dental reciente.",
      fechaInicio: new Date(today.getTime() - 14 * 24 * 60 * 60 * 1000), // Hace 14 d√≠as
      duracion: "7 d√≠as",
      observaciones: "Tratamiento completado sin complicaciones.",
      activo: false,
      patientId: patients[0].id,
      userId: user.id,
    },
    {
      nombre: "Rehabilitaci√≥n cardiaca",
      descripcion:
        "Programa de rehabilitaci√≥n post-infarto con ejercicio supervisado y educaci√≥n nutricional.",
      fechaInicio: new Date(today.getTime() - 180 * 24 * 60 * 60 * 1000), // Hace 180 d√≠as
      duracion: "12 semanas",
      observaciones:
        "Programa completado exitosamente. Paciente mejor√≥ capacidad cardiovascular.",
      activo: false,
      patientId: patients[5].id,
      userId: user.id,
    },
  ];

  for (const treatmentData of treatmentsData) {
    try {
      const treatment = await prisma.treatment.create({
        data: treatmentData,
      });
      console.log(
        `‚úÖ Tratamiento creado: ${treatment.nombre} - ${
          treatment.activo ? "Activo" : "Inactivo"
        }`
      );
    } catch (error) {
      console.log(`‚ö†Ô∏è Error creando tratamiento: ${error}`);
    }
  }

  // 6. Estad√≠sticas finales
  const totalPatients = await prisma.patient.count();
  const totalAppointments = await prisma.appointment.count();
  const totalTreatments = await prisma.treatment.count();
  const pendingAppointments = await prisma.appointment.count({
    where: { estatus: "PENDIENTE" },
  });
  const activeTreatments = await prisma.treatment.count({
    where: { activo: true },
  });

  console.log("\nüìä ESTAD√çSTICAS FINALES:");
  console.log(`üë• Pacientes en total: ${totalPatients}`);
  console.log(`üìÖ Citas en total: ${totalAppointments}`);
  console.log(`üíä Tratamientos en total: ${totalTreatments}`);
  console.log(`‚è≥ Citas pendientes: ${pendingAppointments}`);
  console.log(`üü¢ Tratamientos activos: ${activeTreatments}`);

  console.log("\nüéâ ¬°Seed completado exitosamente!");
  console.log("\nüîë CREDENCIALES DE ACCESO:");
  console.log("üìß Email: admin@admin.com");
  console.log("üîí Password: admin");
}

main()
  .catch((e) => {
    console.error("‚ùå Error durante el seed:", e);
    process.exit(1);
  })
  .finally(async () => {
    await prisma.$disconnect();
    console.log("üì¶ Conexi√≥n a la base de datos cerrada.");
  });
